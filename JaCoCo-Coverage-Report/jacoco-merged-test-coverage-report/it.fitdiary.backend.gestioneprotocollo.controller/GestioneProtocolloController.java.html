<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GestioneProtocolloController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">it.fitdiary.backend.gestioneprotocollo.controller</a> &gt; <span class="el_source">GestioneProtocolloController.java</span></div><h1>GestioneProtocolloController.java</h1><pre class="source lang-java linenums">package it.fitdiary.backend.gestioneprotocollo.controller;

import it.fitdiary.backend.entity.Protocollo;
import it.fitdiary.backend.entity.Ruolo;
import it.fitdiary.backend.entity.Utente;
import it.fitdiary.backend.gestioneprotocollo.service.GestioneProtocolloService;
import it.fitdiary.backend.gestioneutenza.service.GestioneUtenzaService;
import it.fitdiary.backend.utility.FileUtility;
import it.fitdiary.backend.utility.ResponseHandler;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.multipart.support.MissingServletRequestPartException;

import javax.servlet.http.HttpServletRequest;
import java.io.File;
import java.io.IOException;
import java.time.LocalDate;

import static org.springframework.http.HttpStatus.BAD_REQUEST;

@RestController
<span class="fc" id="L35">@Slf4j</span>
@RequestMapping(path = &quot;api/v1/protocolli&quot;)
public class GestioneProtocolloController {
    /**
     * Service di gestione protocollo.
     */
    private final GestioneProtocolloService gestioneProtocolloService;
    /**
     * Service di gestione utenza.
     */
    private final GestioneUtenzaService gestioneUtenzaService;

    /**
     * @param gestioneProtocolloServ
     * @param gestioneUtenzaServ
     */
    @Autowired
    public GestioneProtocolloController(
            final GestioneProtocolloService gestioneProtocolloServ,
<span class="fc" id="L54">            final GestioneUtenzaService gestioneUtenzaServ) {</span>
<span class="fc" id="L55">        this.gestioneProtocolloService = gestioneProtocolloServ;</span>
<span class="fc" id="L56">        this.gestioneUtenzaService = gestioneUtenzaServ;</span>
<span class="fc" id="L57">    }</span>

    @PostMapping
    private ResponseEntity&lt;Object&gt; creazioneProtocollo(
            @RequestParam(&quot;dataScadenza&quot;) final String dataScadenza,
            @RequestParam(&quot;idCliente&quot;) final Long idCliente,
            @RequestParam(value = &quot;schedaAlimentare&quot;, required = false)
            final MultipartFile schedaAlimentareMultipartFile,
            @RequestParam(value = &quot;schedaAllenamento&quot;, required = false)
            final MultipartFile schedaAllenamentoMultipartFile) {
        HttpServletRequest request = ((ServletRequestAttributes)
<span class="fc" id="L68">                RequestContextHolder.getRequestAttributes()).getRequest();</span>

<span class="fc" id="L70">        Long idPreparatore = Long.parseLong(</span>
<span class="fc" id="L71">                request.getUserPrincipal().getName());</span>

<span class="fc" id="L73">        Utente preparatore = gestioneUtenzaService.getById(idPreparatore);</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">        if (!gestioneUtenzaService.existsByPreparatoreAndId(</span>
                preparatore, idCliente)) {
<span class="fc" id="L76">            return ResponseHandler.generateResponse(HttpStatus.UNAUTHORIZED,</span>
                    (Object) &quot;Il preparatore non può creare &quot;
                            + &quot;un protocollo per questo cliente&quot;);
        }
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">        if ((schedaAllenamentoMultipartFile == null</span>
<span class="pc bpc" id="L81" title="1 of 4 branches missed.">                || schedaAllenamentoMultipartFile.isEmpty())</span>
                &amp;&amp; (schedaAlimentareMultipartFile == null
<span class="fc bfc" id="L83" title="All 2 branches covered.">                || schedaAlimentareMultipartFile.isEmpty())) {</span>
<span class="fc" id="L84">            return ResponseHandler.generateResponse(BAD_REQUEST, (Object)</span>
                    &quot;Almeno uno dei due file deve essere presente&quot;);
        }

<span class="fc" id="L88">        Protocollo protocollo = new Protocollo();</span>
<span class="fc" id="L89">        protocollo.setDataScadenza(LocalDate.parse(dataScadenza));</span>
<span class="fc" id="L90">        protocollo.setCliente(gestioneUtenzaService.getById(idCliente));</span>
<span class="fc" id="L91">        protocollo.setPreparatore(gestioneUtenzaService.getById(idPreparatore));</span>
        File schedaAlimentareFile;
        File schedaAllenamentoFile;
        try {
<span class="fc" id="L95">            schedaAlimentareFile =</span>
<span class="fc" id="L96">                    FileUtility.getFile(schedaAlimentareMultipartFile);</span>
<span class="fc" id="L97">            schedaAllenamentoFile =</span>
<span class="fc" id="L98">                    FileUtility.getFile(schedaAllenamentoMultipartFile);</span>
<span class="nc" id="L99">        } catch (Exception e) {</span>
<span class="nc" id="L100">            return ResponseHandler.generateResponse(</span>
                    HttpStatus.INTERNAL_SERVER_ERROR,
                    &quot;errore nella lettura dei file&quot;);
<span class="fc" id="L103">        }</span>
        try {
<span class="fc" id="L105">            Protocollo newProtocollo =</span>
<span class="fc" id="L106">                    gestioneProtocolloService.creazioneProtocollo(protocollo,</span>
                            schedaAlimentareFile, schedaAllenamentoFile);
<span class="fc" id="L108">            return ResponseHandler.generateResponse(HttpStatus.CREATED,</span>
                    &quot;protocollo&quot;, newProtocollo);
<span class="nc" id="L110">        } catch (IOException e) {</span>
<span class="nc" id="L111">            return ResponseHandler.generateResponse(</span>
                    HttpStatus.INTERNAL_SERVER_ERROR,
                    &quot;Errore nella lettura dei file&quot;);
<span class="fc" id="L114">        } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L115">            return ResponseHandler.generateResponse(BAD_REQUEST,</span>
<span class="fc" id="L116">                    (Object) e.getMessage());</span>
        }
    }

    @PutMapping(&quot;{idProtocollo}&quot;)
    private ResponseEntity&lt;Object&gt; modificaProtocollo(
            @PathVariable(&quot;idProtocollo&quot;) final Long idProtocollo,
            @RequestParam(value = &quot;schedaAlimentare&quot;, required = false)
            final MultipartFile schedaAlimentareMultipartFile,
            @RequestParam(value = &quot;schedaAllenamento&quot;, required = false)
            final MultipartFile schedaAllenamentoMultipartFile) {
        HttpServletRequest request = ((ServletRequestAttributes)
<span class="fc" id="L128">                RequestContextHolder.getRequestAttributes()).getRequest();</span>

<span class="fc" id="L130">        Long idPreparatore = Long.parseLong(</span>
<span class="fc" id="L131">                request.getUserPrincipal().getName());</span>
<span class="fc" id="L132">        Utente preparatore = gestioneUtenzaService.getById(idPreparatore);</span>
<span class="fc" id="L133">        Protocollo protocollo = null;</span>
        try {
<span class="fc" id="L135">            protocollo =</span>
<span class="fc" id="L136">                    gestioneProtocolloService.getByIdProtocollo(idProtocollo);</span>
<span class="nc" id="L137">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L138">            return ResponseHandler.generateResponse(HttpStatus.UNAUTHORIZED,</span>
                    (Object)
                            &quot;Il protocollo da modificare non esiste&quot;);
<span class="fc" id="L141">        }</span>
<span class="fc" id="L142">        Long idCliente = protocollo.getCliente().getId();</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">        if (!gestioneUtenzaService.existsByPreparatoreAndId(preparatore,</span>
                idCliente)) {
<span class="fc" id="L145">            return ResponseHandler.generateResponse(HttpStatus.UNAUTHORIZED,</span>
                    (Object)
                            &quot;Il preparatore non può modificare &quot;
                            + &quot;un protocollo per questo cliente&quot;);
        }
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">        if ((schedaAllenamentoMultipartFile == null</span>
<span class="pc bpc" id="L151" title="1 of 4 branches missed.">                || schedaAllenamentoMultipartFile.isEmpty())</span>
                &amp;&amp; (schedaAlimentareMultipartFile == null
<span class="fc bfc" id="L153" title="All 2 branches covered.">                || schedaAlimentareMultipartFile.isEmpty())) {</span>
<span class="fc" id="L154">            return ResponseHandler.generateResponse(BAD_REQUEST,</span>
                    (Object)
                            &quot;Almeno uno dei due file deve essere presente&quot;);
        }

        File schedaAlimentareFile;
        File schedaAllenamentoFile;
        try {
<span class="fc" id="L162">            schedaAlimentareFile =</span>
<span class="fc" id="L163">                    FileUtility.getFile(schedaAlimentareMultipartFile);</span>
<span class="fc" id="L164">            schedaAllenamentoFile =</span>
<span class="fc" id="L165">                    FileUtility.getFile(schedaAllenamentoMultipartFile);</span>
<span class="nc" id="L166">        } catch (Exception e) {</span>
<span class="nc" id="L167">            return ResponseHandler.generateResponse(</span>
                    HttpStatus.INTERNAL_SERVER_ERROR,
                    &quot;errore nella lettura dei file&quot;);
<span class="fc" id="L170">        }</span>
        try {
<span class="fc bfc" id="L172" title="All 2 branches covered.">            if (schedaAlimentareFile != null) {</span>
<span class="fc" id="L173">                gestioneProtocolloService.inserisciSchedaAlimentare(</span>
                        protocollo,
                        schedaAlimentareFile);
            }
<span class="fc bfc" id="L177" title="All 2 branches covered.">            if (schedaAllenamentoFile != null) {</span>
<span class="fc" id="L178">                gestioneProtocolloService.inserisciSchedaAllenamento(</span>
                        protocollo,
                        schedaAllenamentoFile);
            }
<span class="fc" id="L182">            return ResponseHandler.generateResponse(HttpStatus.CREATED,</span>
                    &quot;protocollo&quot;, protocollo);
<span class="nc" id="L184">        } catch (IOException e) {</span>
<span class="nc" id="L185">            return ResponseHandler.generateResponse(</span>
                    HttpStatus.INTERNAL_SERVER_ERROR,
                    &quot;Errore nella lettura dei file&quot;);
<span class="fc" id="L188">        } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L189">            return ResponseHandler.generateResponse(BAD_REQUEST,</span>
                    &quot;protocollo&quot;,
<span class="fc" id="L191">                    e.getMessage());</span>
        }
    }

    /**
     * Questa funzione permette di visualizzare
     * un proprio protocollo da parte di un cliente.
     *
     * @param id indica l' identificativo del protocollo
     * @return protocollo selezionato
     * @throws IOException
     */
    @GetMapping(&quot;{id}&quot;)
    public ResponseEntity&lt;Object&gt; visualizzaProtocollo(
            @PathVariable(&quot;id&quot;) final Long id)
            throws IOException {
        var request = ((ServletRequestAttributes)
<span class="fc" id="L208">                RequestContextHolder.getRequestAttributes()).getRequest();</span>
<span class="fc" id="L209">        var principal =</span>
<span class="fc" id="L210">                Long.parseLong(request.getUserPrincipal().getName());</span>
<span class="fc" id="L211">        Protocollo protocollo =</span>
<span class="fc" id="L212">                gestioneProtocolloService.getByIdProtocollo(id);</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">        if (protocollo.getCliente().getId() == principal</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">                || protocollo.getPreparatore().getId() == principal) {</span>
<span class="fc" id="L215">            return ResponseHandler.generateResponse(HttpStatus.OK,</span>
                    &quot;protocollo&quot;,
                    protocollo);
        }
<span class="fc" id="L219">        return ResponseHandler.generateResponse(BAD_REQUEST,</span>
                (Object) &quot;l'utente non ha accesso a questo protocollo&quot;);
    }


    /**
     * Questa funzione permette di visualizzare una lista di protocolli.
     *
     * @param idCliente indica l' identificativo del cliente
     * @param page      indica la pagina della lista di protocolli da prendere
     * @return lista protocolli
     */
    @GetMapping
    public ResponseEntity&lt;Object&gt; visualizzaStoricoProtocolli(
            @RequestParam(name =
                    &quot;clienteId&quot;, required = false) final Long idCliente,
            @RequestParam(name = &quot;page&quot;, required = false) final Integer page) {
        HttpServletRequest request = ((ServletRequestAttributes)
<span class="fc" id="L237">                RequestContextHolder.getRequestAttributes()).getRequest();</span>
<span class="fc" id="L238">        Long idUtente = Long.parseLong(</span>
<span class="fc" id="L239">                request.getUserPrincipal().getName());</span>

<span class="fc bfc" id="L241" title="All 2 branches covered.">        if (idCliente != null) {</span>
<span class="fc" id="L242">            return visualizzaStoricoProtocolliPreparatore(idCliente);</span>
        } else {
            Utente user;
            try {
<span class="fc" id="L246">                user = gestioneUtenzaService.getById(idUtente);</span>
<span class="fc" id="L247">            } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L248">                return ResponseHandler.generateResponse(HttpStatus.BAD_REQUEST,</span>
<span class="fc" id="L249">                        (Object) e.getMessage());</span>
<span class="fc" id="L250">            }</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">            if (user.getRuolo().getNome().equals(</span>
                    Ruolo.RUOLOCLIENTE)) {
<span class="fc" id="L253">                return visualizzaStoricoProtocolliClienti();</span>
            } else {
<span class="pc bpc" id="L255" title="1 of 2 branches missed.">                return visualizzaListaProtocollo(page == null ? 1 : page);</span>
            }
        }
    }


    private ResponseEntity&lt;Object&gt; visualizzaListaProtocollo(final int page) {
        HttpServletRequest request = ((ServletRequestAttributes)
<span class="fc" id="L263">                RequestContextHolder.getRequestAttributes()).getRequest();</span>

<span class="fc" id="L265">        Long idPreparatore = Long.parseLong(</span>
<span class="fc" id="L266">                request.getUserPrincipal().getName());</span>
<span class="fc" id="L267">        Utente preparatore = gestioneUtenzaService.getById(idPreparatore);</span>
<span class="fc" id="L268">        return ResponseHandler.generateResponse(HttpStatus.OK,</span>
                &quot;protocollo&quot;,
<span class="fc" id="L270">                gestioneProtocolloService.getAllProtocolliPreparatore(</span>
                        preparatore, page));
    }

    /**
     * @param idCliente id del cliente di
     *                  cui si vuole visualizzare il protocollo
     * @return lista di protocolli del cliente vuota o piena
     */
    public ResponseEntity&lt;Object&gt; visualizzaStoricoProtocolliPreparatore(
            final Long idCliente) {
        HttpServletRequest request = ((ServletRequestAttributes)
<span class="fc" id="L282">                RequestContextHolder.getRequestAttributes()).getRequest();</span>

<span class="fc" id="L284">        Long idPreparatore = Long.parseLong(</span>
<span class="fc" id="L285">                request.getUserPrincipal().getName());</span>
<span class="fc" id="L286">        Utente preparatore = gestioneUtenzaService.getById(idPreparatore);</span>
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">        if (!gestioneUtenzaService.existsByPreparatoreAndId(</span>
                preparatore, idCliente)) {
<span class="nc" id="L289">            return ResponseHandler.generateResponse(HttpStatus.UNAUTHORIZED,</span>
                    (Object)
                            &quot;Il preparatore non può vedere &quot;
                            + &quot;la lista dei protocolli per questo cliente&quot;);
        }
        try {
<span class="fc" id="L295">            Utente utenteCliente = gestioneUtenzaService.getById(idCliente);</span>
<span class="fc" id="L296">            return ResponseHandler.generateResponse(HttpStatus.OK,</span>
                    &quot;protocollo&quot;,
                    gestioneProtocolloService
<span class="fc" id="L299">                            .visualizzaStoricoProtocolliCliente(</span>
                                    utenteCliente));
<span class="nc" id="L301">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L302">            return ResponseHandler.generateResponse(HttpStatus.BAD_REQUEST,</span>
<span class="nc" id="L303">                    (Object) e.getMessage());</span>
        }
    }


    /**
     * @return storico dei protocolli del cliente autenticato
     */
    public ResponseEntity&lt;Object&gt; visualizzaStoricoProtocolliClienti() {
        HttpServletRequest request = ((ServletRequestAttributes)
<span class="fc" id="L313">                RequestContextHolder.getRequestAttributes()).getRequest();</span>
<span class="fc" id="L314">        Long idCliente = Long.parseLong(</span>
<span class="fc" id="L315">                request.getUserPrincipal().getName());</span>
<span class="fc" id="L316">        Utente cliente = null;</span>
        try {
<span class="fc" id="L318">            cliente = gestioneUtenzaService.getById(idCliente);</span>
<span class="fc" id="L319">            return ResponseHandler.generateResponse(HttpStatus.OK,</span>
                    &quot;protocollo&quot;,
                    gestioneProtocolloService
<span class="fc" id="L322">                            .visualizzaStoricoProtocolliCliente(</span>
                                    cliente));
<span class="nc" id="L324">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L325">            return ResponseHandler.generateResponse(HttpStatus.BAD_REQUEST,</span>
<span class="nc" id="L326">                    (Object) e.getMessage());</span>
        }
    }

    /**
     * cattura dell'errore MissingServletRequestPartException.
     *
     * @param ex errore
     * @return messaggio di errore formato jsend
     */
    @ExceptionHandler(MissingServletRequestPartException.class)
    public ResponseEntity&lt;Object&gt; handleMissingRequestBody(
            final MissingServletRequestPartException ex) {
<span class="nc" id="L339">        return ResponseHandler.generateResponse(HttpStatus.BAD_REQUEST,</span>
<span class="nc" id="L340">                (Object) ex.getMessage());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>